#!/bin/bash

unzip source.zip -d tmp
cd tmp
mv source ../source-test
cd ..
rm -r tmp
cd source-test

# instrumentation
sed -i '481i int __fuzzfix2 = 0; \n if (__fuzzfix2) goto format_error;' src/bitmap_io.c

git init
git add .
git commit -m "first commit"

# apply patch
git apply ../result-1/formatted.patch

# build
PROJECT_CFLAGS="-g -O0 -static"
./configure CFLAGS="${PROJECT_CFLAGS}"
PROJECT_CFLAGS="-g -O0 -fsanitize=address  -ggdb -static"
PROJECT_LDFLAGS="-fsanitize=address -static"
make CFLAGS="${PROJECT_CFLAGS}" LDFLAGS="${PROJECT_LDFLAGS}" -j`nproc`

if [ $? -eq 0 ]; then
    echo "Build OK"
else
    echo "Build failed"
    exit 122
fi

bin=potrace
cp src/$bin ../
cd ../

ASAN_OPTIONS=detect_leaks=0:handle_abort=1:exitcode=123 UBSAN_OPTIONS=halt_on_error=1:exitcode=123 ./$bin ./exploit
