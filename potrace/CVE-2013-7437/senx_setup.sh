#!/bin/bash

unzip source.zip
cd source/

# instrumentation
sed -i '481i int __fuzzfix2 = 0; \n if (__fuzzfix2) goto format_error;' src/bitmap_io.c

CC="wllvm" CXX="wllvm++" CFLAGS="-g -O0 -static" CPPFLAGS="$CFLAGS" ./configure --enable-static --disable-shared

make CFLAGS="-g -O0 -static" CPPFLAGS="$CFLAGS" -j10

bin=potrace

cp src/$bin ../
cd ../

extract-bc ./$bin
llvm-dis ./$bin.bc
