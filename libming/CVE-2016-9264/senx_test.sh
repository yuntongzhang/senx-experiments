#!/bin/bash
git clone https://github.com/libming/libming.git source-test
cd source-test
git checkout cc6a386

# insert patch template at developer location
sed -i '124i if(0) error("invalid samplerate index");' util/listmp3.c

# apply patch
git add .
git commit -m "Before patch"
git apply ../result-1/formatted.patch

# build
./autogen.sh
PROJECT_CFLAGS="-g -O0 -static"
PROJECT_CONFIG_OPTIONS="--disable-freetype"
./configure CFLAGS="${PROJECT_CFLAGS}" ${PROJECT_CONFIG_OPTIONS}
PROJECT_CFLAGS="-fsanitize=address -static -O0 -ggdb"
PROJECT_CXXFLAGS="-fsanitize=address -static -O0 -ggdb"
PROJECT_LDFLAGS="-static -fsanitize=address"
make CFLAGS="${PROJECT_CFLAGS}" CXXFLAGS="${PROJECT_CXXFLAGS}" LDFLAGS="${PROJECT_LDFLAGS}"

if [ $? -eq 0 ]; then
    echo "Build OK"
else
    echo "Build failed"
    exit 122
fi


bin=listmp3
cp util/$bin ../
cd ../

ASAN_OPTIONS=detect_leaks=0:handle_abort=1:exitcode=123 UBSAN_OPTIONS=halt_on_error=1:exitcode=123 ./$bin ./exploit
