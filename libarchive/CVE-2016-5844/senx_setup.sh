#!/bin/bash
git clone https://github.com/libarchive/libarchive.git source
cd source
git checkout v3.2.0

# perform some macro expansion on source code
fix_file=libarchive/archive_read_support_format_iso9660.c
grep '^\s*#\s*include' $fix_file > /tmp/include.c
grep -Pv '^\s*#\s*include\b' $fix_file > /tmp/code.c
gcc -E /tmp/code.c | grep -v ^# > /tmp/preprocessed.c
cat /tmp/include.c > $fix_file.done
cat /tmp/preprocessed.c >> $fix_file.done
mv $fix_file $fix_file.old
mv $fix_file.done $fix_file

autoreconf -i

CC="wllvm" CXX="wllvm++" CFLAGS="-g -O0 -static" CXXFLAGS="$CFLAGS" ./configure --without-openssl

make CFLAGS="-g -O0 -static" CXXFLAGS="$CFLAGS"

bin=bsdtar

cp ./$bin ../
cd ../

extract-bc ./$bin
llvm-dis ./$bin.bc
