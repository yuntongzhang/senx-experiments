#!/bin/bash
git clone https://github.com/libarchive/libarchive.git source-test
cd source-test
git checkout v3.2.0

# perform some macro expansion on source code
fix_file=libarchive/archive_read_support_format_iso9660.c
grep '^\s*#\s*include' $fix_file > /tmp/include.c
grep -Pv '^\s*#\s*include\b' $fix_file > /tmp/code.c
gcc -E /tmp/code.c | grep -v ^# > /tmp/preprocessed.c
cat /tmp/include.c > $fix_file.done
cat /tmp/preprocessed.c >> $fix_file.done
mv $fix_file $fix_file.old
mv $fix_file.done $fix_file

# apply patch
git add .
git commit -m "Before patch"
git apply ../result-1/formatted.patch

# build
autoreconf -i
./configure --without-openssl

PROJECT_CFLAGS="-fsanitize=signed-integer-overflow -O0 -static -g -Wno-error"
PROJECT_LDFLAGS="-static"
make CFLAGS="${PROJECT_CFLAGS}" LDFLAGS="${PROJECT_LDFLAGS}" -j`nproc`

if [ $? -eq 0 ]; then
    echo "Build OK"
else
    echo "Build failed"
    exit 122
fi

bin=bsdtar
cp ./$bin ../
cd ../

ASAN_OPTIONS=detect_leaks=0:handle_abort=1:exitcode=123 UBSAN_OPTIONS=halt_on_error=1:exitcode=123 ./$bin -tf ./libarchive-signed-int-overflow.iso
