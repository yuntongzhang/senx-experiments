#!/bin/bash
git clone https://github.com/libjpeg-turbo/libjpeg-turbo.git source
cd source/
git checkout beefb62

# convert some enums to int (enum J_COLOR_SPACE)
sed -i 's/\bJCS_UNKNOWN\b/0/g' wrbmp.c
sed -i 's/\bJCS_GRAYSCALE\b/1/g' wrbmp.c
sed -i 's/\bJCS_RGB\b/2/g' wrbmp.c
sed -i 's/\bJCS_YCbCr\b/3/g' wrbmp.c
sed -i 's/\bJCS_CMYK\b/4/g' wrbmp.c
sed -i 's/\bJCS_YCCK\b/5/g' wrbmp.c
sed -i 's/\bJCS_EXT_RGB\b/6/g' wrbmp.c
sed -i 's/\bJCS_EXT_RGBX\b/7/g' wrbmp.c
sed -i 's/\bJCS_EXT_BGR\b/8/g' wrbmp.c
sed -i 's/\bJCS_EXT_BGRX\b/9/g' wrbmp.c
sed -i 's/\bJCS_EXT_XBGR\b/10/g' wrbmp.c
sed -i 's/\bJCS_EXT_XRGB\b/11/g' wrbmp.c
sed -i 's/\bJCS_EXT_RGBA\b/12/g' wrbmp.c
sed -i 's/\bJCS_EXT_BGRA\b/13/g' wrbmp.c
sed -i 's/\bJCS_EXT_ABGR\b/14/g' wrbmp.c
sed -i 's/\bJCS_EXT_ARGB\b/15/g' wrbmp.c
sed -i 's/\bJCS_RGB565\b/16/g' wrbmp.c

mkdir build; cd build;
cmake -G"Unix Makefiles" -DCMAKE_C_COMPILER="wllvm"  -DCMAKE_C_FLAGS_RELEASE='-g -O0 -D_NO_STRING_INLINES -DFORTIFY_SOURCE=0' -DREQUIRE_SIMD=0 -DWITH_SIMD=0 ..

make

bin=djpeg

cp ./$bin ../../
cd ../../

extract-bc ./$bin
llvm-dis ./$bin.bc
