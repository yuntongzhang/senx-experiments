#!/bin/bash
git clone https://github.com/libjpeg-turbo/libjpeg-turbo.git source-test
cd source-test
git checkout ae8cdf5

# instrumentation
sed -i '145i if (0) exit(1);\n' rdbmp.c

# apply patch
git add .
git commit -m "Before patch"
git apply ../result-1/formatted.patch

# build
autoreconf -i
./configure CFLAGS="-g -O0 -static" --without-simd
PROJECT_CFLAGS="-g -O0 -fsanitize=address  -static -ggdb"
PROJECT_LDFLAGS="-static -fsanitize=address"
make CFLAGS="${PROJECT_CFLAGS}" LDFLAGS="${PROJECT_LDFLAGS}" -j`nproc`

if [ $? -eq 0 ]; then
    echo "Build OK"
else
    echo "Build failed"
    exit 122
fi

bin=cjpeg
cp ./$bin ../
cd ../

ASAN_OPTIONS=detect_leaks=0:handle_abort=1:exitcode=123 UBSAN_OPTIONS=halt_on_error=1:exitcode=123 ./$bin -outfile out.tmp ./exploit 
