#!/bin/bash
git clone https://github.com/jasper-software/jasper.git source
cd source
git checkout 3c55b399c36ef46befcb21e4ebc4799367f89684

# fix compile
sed -i "s/inline bool jas_safe_size_mul/inline static bool jas_safe_size_mul/g" src/libjasper/base/jas_malloc.c

# instrumentation
sed -i '515i if(0) return -1;' src/libjasper/jpc/jpc_cs.c

autoreconf -i
CC="wllvm" CXX="wllvm++" CFLAGS="-static -g -O0" CXXFLAGS="$CFLAGS" ./configure
make CFLAGS="-static -g -O0" CXXFLAGS="$CFLAGS"

bin=imginfo

cp src/appl/$bin ../
cd ../

extract-bc ./$bin
llvm-dis ./$bin.bc
