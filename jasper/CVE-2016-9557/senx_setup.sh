#!/bin/bash
git clone https://github.com/jasper-software/jasper.git source
cd source/
git checkout version-1.900.17

# fix compile error
sed -i "s/inline bool jas_safe_size_mul/inline static bool jas_safe_size_mul/g" src/libjasper/base/jas_malloc.c

# instrumentation
sed -i '162i if(0) return 0;' src/libjasper/base/jas_image.c

autoreconf -i
CC="wllvm" CXX="wllvm++" CFLAGS="-static -g -O0" CXXFLAGS="$CFLAGS" ./configure
make CFLAGS="-static -g -O0" CXXFLAGS="$CFLAGS"

bin=imginfo

cp src/appl/$bin ../
cd ../

extract-bc ./$bin
llvm-dis ./$bin.bc
